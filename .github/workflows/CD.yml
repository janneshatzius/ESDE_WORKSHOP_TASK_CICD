name: CD (Docker & Pages)

on:
  workflow_run:
    workflows: ["CI (Build & Test)"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

concurrency:
  group: cd-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# NOTE: Keep permissions minimal by default.
# ENABLE only once you actually need it.
permissions:
  contents: read
  # packages: write   # TODO (Docker): required to push images to GHCR
  # pages: write      # TODO (Pages): required to deploy GitHub Pages
  # id-token: write   # TODO (Pages): required by deploy-pages for OIDC

jobs:
  docker:
    name: Docker Skeleton
    # Run after successful CI or when manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CI commit (or current on manual run)
        uses: actions/checkout@v4
        with:
          # For workflow_run, this is the commit that CI built.
          # For manual runs, fall back to the current commit.
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Buildx (multi-arch builder)
        uses: docker/setup-buildx-action@v3

      # ------------------------- STUDENT TODOs (Docker & E2E) -------------------------
      # TODO 1 – Log in to a container registry (e.g., GHCR or Docker Hub)
      #
      # Expectation:
      # - Authenticate to the chosen registry so that subsequent pushes (and pulls for E2E)
      #   are authorized.
      # - For GHCR, use the built-in GITHUB_TOKEN with the correct registry hostname.
      # - For Docker Hub, use username + token from repo variables/secrets.
      #
      # Example behaviour (students must implement themselves):
      # - Use docker/login-action or an equivalent login command.
      # - Use appropriate credentials: either GITHUB_TOKEN or Docker Hub PAT.
      #
      # - name: TODO – login to container registry
      #   run: echo "Authenticate to the chosen registry (GHCR or Docker Hub)."

      # TODO 2 – Build and push a Docker image for this repository
      #
      # Expectation:
      # - Use the repository root (.) as the build context.
      # - Tag the image in the correct namespace:
      #     - GHCR: ghcr.io/<owner>/<repo>:<tag>
      #     - Docker Hub: <dockerhub-user>/workshop:<tag>
      # - Push at least two tags:
      #     - A stable tag (e.g., 'latest').
      #     - A commit-specific tag (e.g., based on GITHUB_SHA).
      # - Optionally use build cache to speed up future builds.
      #
      # - name: TODO – build & push Docker image
      #   run: echo "Build the image and push it with stable + commit-specific tags."

      # TODO 3 – End-to-end (E2E) container smoke test
      #
      # Goal:
      # - Verify that the freshly built image actually runs and responds correctly.
      #
      # Expectation:
      # - Start a container from the just-pushed image.
      # - Wait until the application is healthy (e.g., polling /api/health).
      # - Call at least one "real" endpoint (e.g., /api/info) and fail the job if it
      #   does not return a successful response.
      # - Stop the container at the end (even on failure).
      #
      # - name: TODO – run E2E smoke test against container
      #   run: echo "Run the container from the new image and verify /api/health and /api/info."
      # -----------------------------------------------------------------------

      - name: Placeholder
        run: echo "Docker CD TODOs go here (login, build+push, E2E container test)."

  pages:
    name: Pages Skeleton
    needs: docker
    runs-on: ubuntu-latest
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout CI commit (or current on manual run)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v4

      # ------------------------- STUDENT TODOs (Pages) -------------------------
      # TODO 4 – Re-run tests and generate coverage reports
      #
      # Expectation:
      # - Run the test suite again in the CD context.
      # - Generate the coverage XML that the Pages generator can read.
      #
      # - name: TODO – run tests & generate coverage
      #   run: echo "Re-run tests and produce coverage report."

      # TODO 5 – Generate static files for the GitHub Pages site
      #
      # Expectation:
      # - Execute the task/class that writes the docs/ directory (e.g., JSON + HTML).
      # - Include information such as build version or run number in the output.
      #
      # - name: TODO – generate Pages content (docs/)
      #   run: echo "Generate build summary files into docs/."

      # TODO 6 – Configure and deploy GitHub Pages
      #
      # Expectation:
      # - Enable the necessary permissions at the top of the workflow (pages + id-token).
      # - Use the official actions to:
      #   1) configure Pages,
      #   2) upload the docs/ directory as an artifact,
      #   3) deploy that artifact to the Pages environment.
      # - Expose the final Pages URL via the job summary (environment url).
      #
      # - name: TODO – configure GitHub Pages
      #   run: echo "Call the action that prepares this repo for a Pages deployment."
      #
      # - name: TODO – upload Pages artifact
      #   run: echo "Upload the docs/ folder as the site artifact."
      #
      # - name: TODO – deploy to GitHub Pages
      #   run: echo "Deploy the uploaded artifact to the GitHub Pages environment."
      # --------------------------------------------------------------------------

      - name: Placeholder
        run: echo "Pages deployment TODOs go here (tests, exportPagesData, upload, deploy)."
      # ---------------------------------------------------

